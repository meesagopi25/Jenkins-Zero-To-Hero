stage('Update Deployment File') {
  environment {
    GIT_REPO_NAME = "Jenkins-Zero-To-Hero"
    GIT_USER_NAME = "meesagopi25"
  }
  steps {
    withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
      sh '''
        echo "Workspace: $WORKSPACE"
        ls -la $WORKSPACE/.git

        # Force Git to use the correct repo
        git -C "$WORKSPACE" config user.email "meesala.gopi@gmail.com"
        git -C "$WORKSPACE" config user.name "Gopi Meesala"

        sed -i "s/replaceImageTag/${BUILD_NUMBER}/g" \
          $WORKSPACE/java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml

        git -C "$WORKSPACE" add \
          java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml

        git -C "$WORKSPACE" commit -m "Update deployment image to version ${BUILD_NUMBER}" \
          || echo "No changes to commit"

        git -C "$WORKSPACE" push \
          https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main
      '''
    }
  }
}
